FROM gradle:9.2.0-jdk25 AS build
COPY stashless-core/src /app/stashless-core/src
COPY stashless-core/build.gradle.kts /app/stashless-core
COPY stashless-authorization-server/src /app/stashless-authorization-server/src
COPY stashless-authorization-server/build.gradle.kts /app/stashless-authorization-server
COPY stashless-api/src /app/stashless-api/src
COPY stashless-api/build.gradle.kts /app/stashless-api
COPY settings.gradle.kts /app
COPY buildSrc /app/buildSrc
COPY gradle /app/gradle
WORKDIR /app
RUN gradle :stashless-api:bootJar -x test --no-daemon --parallel

FROM eclipse-temurin:25
RUN apt update
RUN apt install -y curl
COPY --from=build /app/stashless-api/build/libs/stashless-api-0.0.1.jar /app/app.jar
ENV SPRING_PROFILES_ACTIVE=core,api
CMD ["java", "-jar", "/app/app.jar"]
